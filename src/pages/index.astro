---
import BaseLayout from '../layouts/BaseLayout.astro';
import PointCloudViewer from '../components/PointCloudViewer.tsx';
---

<BaseLayout title="Ethan Kong">
  <!-- Animated topographic background canvas -->
  <canvas id="bg-canvas" class="bg-canvas"></canvas>

  <main class="landing">
    <!-- Left: 3D Viewer -->
    <section class="landing-viewer">
      <PointCloudViewer src="/assets/3dImage.lssnap" client:only="react" />
    </section>

    <!-- Right: Bio Card -->
    <section class="landing-bio">
      <div class="bio-card glass-card" id="bio-card">
        <p class="bio-greeting">
          hi i'm <span class="hero-name">ETHAN KONG</span>
        </p>

        <p class="bio-text">
          I was born and raised in Hong Kong and am now studying Aeronautics
          and Astronautics at Stanford. I love to make cool and fun projects,
          which you can take a look at here. I hope you enjoy exploring my
          projects as much as I enjoyed working on them.
        </p>
        <p class="bio-text">
          I'm currently working with the Plasma Physics Lab and am part of the
          Solar Car Project, Stanford Student Robotics, and Stanford Space
          Initiative. Outside of my studies, I enjoy sailing and throwing
          pottery on the wheel.
        </p>

        <p class="bio-contact-label">Feel free to reach out:</p>

        <div class="bio-contacts">
          <a href="mailto:ethank07@stanford.edu" class="contact-icon" aria-label="Email">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
              <rect x="2" y="4" width="20" height="16" rx="2"/>
              <path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/>
            </svg>
          </a>
          <a href="https://github.com/DoggoOP" target="_blank" class="contact-icon" aria-label="GitHub">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0 1 12 6.844a9.59 9.59 0 0 1 2.504.337c1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.02 10.02 0 0 0 22 12.017C22 6.484 17.522 2 12 2z"/>
            </svg>
          </a>
          <a href="https://www.linkedin.com/in/ethank07/" target="_blank" class="contact-icon" aria-label="LinkedIn">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
              <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 0 1-2.063-2.065 2.064 2.064 0 1 1 2.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
            </svg>
          </a>
          <a href="/assets/resume.pdf" download class="contact-icon" aria-label="Resume">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
              <polyline points="14,2 14,8 20,8"/>
              <line x1="12" y1="18" x2="12" y2="12"/>
              <polyline points="9,15 12,18 15,15"/>
            </svg>
          </a>
        </div>

        <button data-open-projects class="bio-projects-link">
          View Projects
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <path d="M5 12h14M12 5l7 7-7 7"/>
          </svg>
        </button>
      </div>
    </section>
  </main>
</BaseLayout>

<style>
  /* Full-viewport canvas background */
  .bg-canvas {
    position: fixed;
    inset: 0;
    z-index: 0;
    width: 100%;
    height: 100%;
  }

  .landing {
    position: relative;
    z-index: 1;
    display: flex;
    height: 100vh;
    padding-top: 56px;
  }

  .landing-viewer {
    flex: 0 0 58%;
    height: 100%;
    position: relative;
  }

  .landing-bio {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 40px 48px 40px 24px;
  }

  .bio-card {
    width: 100%;
    max-width: 440px;
    padding: 36px 40px;
    display: flex;
    flex-direction: column;
    gap: 16px;
    /* 3D tilt uses JS — needs perspective on parent */
    transform-style: preserve-3d;
    transition: transform 0.12s ease-out, box-shadow 0.12s ease-out;
    will-change: transform;
  }

  .bio-card:hover {
    box-shadow: 0 24px 60px rgba(0, 212, 255, 0.12), 0 8px 24px rgba(0,0,0,0.4);
  }

  .bio-greeting {
    font-size: 28px;
    font-weight: 800;
    line-height: 1.2;
    letter-spacing: -0.02em;
  }

  .hero-name {
    color: rgba(255, 255, 255, 0.95);
  }

  .bio-text {
    font-size: 14px;
    line-height: 1.7;
    color: var(--text-secondary);
  }

  .bio-contact-label {
    font-size: 13px;
    color: var(--text-muted);
    margin-top: 4px;
  }

  .bio-contacts {
    display: flex;
    gap: 20px;
    align-items: center;
  }

  .contact-icon {
    color: var(--text-secondary);
    transition: color 0.2s, transform 0.2s;
  }
  .contact-icon:hover {
    color: var(--accent-cyan);
    transform: translateY(-2px);
  }

  .bio-projects-link {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    margin-top: 8px;
    padding: 10px 22px;
    background: linear-gradient(135deg, rgba(0,212,255,0.12), rgba(123,47,247,0.12));
    border: 1px solid var(--border-accent);
    border-radius: var(--radius-btn);
    font-size: 14px;
    font-weight: 600;
    color: var(--accent-cyan);
    align-self: flex-start;
    cursor: pointer;
    font-family: inherit;
    transition: background 0.2s, transform 0.2s;
  }
  .bio-projects-link:hover {
    background: linear-gradient(135deg, rgba(0,212,255,0.2), rgba(123,47,247,0.2));
    transform: translateX(2px);
  }
</style>

<script>
  let _bgRafId = -1;
  let _bgResize: (() => void) | null = null;

  // ─── Rising smoke fluid background ─────────────────────────────────────────
  function initBg() {
    const canvas = document.getElementById('bg-canvas') as HTMLCanvasElement | null;
    if (!canvas) return;
    const ctx = canvas.getContext('2d')!;

    // Grid — 200×112 keeps pressure solver fast at 60fps
    const W = 200, H = 112, N = W * H;

    let u  = new Float32Array(N), u2 = new Float32Array(N);
    let v  = new Float32Array(N), v2 = new Float32Array(N);
    let c  = new Float32Array(N), c2 = new Float32Array(N); // smoke density 0→1
    const p   = new Float32Array(N);
    const div = new Float32Array(N);

    // Start with small random velocity seed so smoke immediately curls
    for (let I = 0; I < N; I++) {
      u[I] = (Math.random() - 0.5) * 0.04;
      v[I] = (Math.random() - 0.5) * 0.04;
    }

    const off = document.createElement('canvas');
    off.width = W; off.height = H;
    const offCtx = off.getContext('2d')!;
    const imgData = offCtx.createImageData(W, H);
    const pix = imgData.data;

    _bgResize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
    _bgResize();
    window.addEventListener('resize', _bgResize);

    function clamp(x: number, lo: number, hi: number) { return x < lo ? lo : x > hi ? hi : x; }
    function gidx(xi: number, yi: number) {
      return (clamp(yi | 0, 0, H-1) * W) + clamp(xi | 0, 0, W-1);
    }
    function samp(f: Float32Array, x: number, y: number) {
      const x0 = x|0, y0 = y|0, fx = x-x0, fy = y-y0;
      return f[gidx(x0,   y0)]   * (1-fx)*(1-fy)
           + f[gidx(x0+1, y0)]   *  fx   *(1-fy)
           + f[gidx(x0,   y0+1)] * (1-fx)* fy
           + f[gidx(x0+1, y0+1)] *  fx   * fy;
    }
    function advect(src: Float32Array, dst: Float32Array, dt: number) {
      for (let j = 0; j < H; j++) {
        for (let i = 0; i < W; i++) {
          const I = j*W+i;
          dst[I] = samp(src, i - clamp(u[I],-6,6)*dt, j - clamp(v[I],-6,6)*dt);
        }
      }
    }
    function project() {
      for (let j = 1; j < H-1; j++)
        for (let i = 1; i < W-1; i++) {
          const I = j*W+i;
          div[I] = -0.5*((u[I+1]-u[I-1])+(v[I+W]-v[I-W]));
        }
      p.fill(0);
      for (let iter = 0; iter < 30; iter++)
        for (let j = 1; j < H-1; j++)
          for (let i = 1; i < W-1; i++) {
            const I = j*W+i;
            p[I] = (div[I]+p[I-1]+p[I+1]+p[I-W]+p[I+W])*0.25;
          }
      for (let j = 1; j < H-1; j++)
        for (let i = 1; i < W-1; i++) {
          const I = j*W+i;
          u[I] -= 0.5*(p[I+1]-p[I-1]);
          v[I] -= 0.5*(p[I+W]-p[I-W]);
        }
      // Full no-slip on all four walls
      for (let i = 0; i < W; i++) {
        u[i] = 0; v[i] = 0;                   // top
        u[(H-1)*W+i] = 0; v[(H-1)*W+i] = 0;  // bottom
      }
      for (let j = 0; j < H; j++) {
        u[j*W] = 0; v[j*W] = 0;               // left
        u[j*W+W-1] = 0; v[j*W+W-1] = 0;      // right
      }
    }

    // Diffuse: spread concentration laterally (prevents column artifacts)
    function diffuse(src: Float32Array, dst: Float32Array, k: number) {
      for (let j = 1; j < H-1; j++) {
        for (let i = 1; i < W-1; i++) {
          const I = j*W+i;
          dst[I] = src[I] + k * (src[I-1]+src[I+1]+src[I-W]+src[I+W] - 4*src[I]);
        }
      }
      for (let i = 0; i < W; i++) { dst[i] = src[i]; dst[(H-1)*W+i] = src[(H-1)*W+i]; }
      for (let j = 0; j < H; j++) { dst[j*W] = src[j*W]; dst[j*W+W-1] = src[j*W+W-1]; }
    }

    // Splat: force + optional smoke injection
    function splat(gx: number, gy: number, fu: number, fv: number, rad: number, dc = 0) {
      const x0 = Math.max(0,(gx-rad)|0), x1 = Math.min(W-1,(gx+rad+1)|0);
      const y0 = Math.max(0,(gy-rad)|0), y1 = Math.min(H-1,(gy+rad+1)|0);
      for (let j = y0; j <= y1; j++) {
        for (let i = x0; i <= x1; i++) {
          const d2 = (i-gx)**2+(j-gy)**2;
          if (d2 >= rad*rad) continue;
          const w = Math.exp(-d2/(rad*rad*0.4));
          const I = j*W+i;
          u[I] += fu*w; v[I] += fv*w;
          if (dc > 0) c[I] = Math.min(1, c[I]+dc*w);
        }
      }
    }

    // ── Monochromatic smoke LUT: bright background → dark dense smoke ─────────
    const LUT = 1024;
    const lutR = new Uint8Array(LUT), lutG = new Uint8Array(LUT), lutB = new Uint8Array(LUT);
    const stops: [number, [number,number,number]][] = [
      [0.00, [220, 228, 245]],
      [0.22, [160, 165, 188]],
      [0.42, [85,  90, 110]],
      [0.62, [32,  35,  48]],
      [0.82, [10,  11,  18]],
      [1.00, [4,   4,    8]],
    ];
    for (let k = 0; k < LUT; k++) {
      const t = k/(LUT-1);
      let si = 0;
      while (si < stops.length-2 && t > stops[si+1][0]) si++;
      const [ta,ca] = stops[si], [tb,cb] = stops[si+1];
      const f = (t-ta)/(tb-ta);
      lutR[k] = (ca[0]+f*(cb[0]-ca[0]))|0;
      lutG[k] = (ca[1]+f*(cb[1]-ca[1]))|0;
      lutB[k] = (ca[2]+f*(cb[2]-ca[2]))|0;
    }

    let mx = -1, my = -1, pmx = -1, pmy = -1;
    window.addEventListener('mousemove', (e: MouseEvent) => {
      pmx = mx; pmy = my;
      mx = e.clientX/window.innerWidth*W;
      my = e.clientY/window.innerHeight*H;
    });

    function render() {
      const dt = 1.0;
      const t  = performance.now() * 0.001;

      // ── Slow uniform smoke seeping in from entire bottom edge ───────────
      for (let i = 0; i < W; i++) {
        const wave = 0.65 + 0.35 * Math.sin(t * 0.28 + i * 0.11);
        c[(H-1)*W + i] = Math.min(1, c[(H-1)*W + i] + 0.001 * wave);
        c[(H-2)*W + i] = Math.min(1, c[(H-2)*W + i] + 0.0006 * wave);
      }

      // ── Mouse stirs the smoke ────────────────────────────────────────────
      if (mx >= 0 && pmx >= 0) {
        splat(mx, my, (mx-pmx)*4, (my-pmy)*4, 10);
      }
      pmx = mx; pmy = my;

      // ── Buoyancy: smoke rises proportional to density ────────────────────
      for (let I = 0; I < N; I++) v[I] -= c[I] * 0.025;

      // ── Velocity advect + project ────────────────────────────────────────
      advect(u, u2, dt); advect(v, v2, dt);
      [u, u2] = [u2, u]; [v, v2] = [v2, v];
      project();

      // ── Smoke advect + diffuse ────────────────────────────────────────────
      advect(c, c2, dt);
      [c, c2] = [c2, c];
      diffuse(c, c2, 0.12);
      [c, c2] = [c2, c];

      // ── Top outlet: let smoke escape at ceiling ───────────────────────────
      for (let i = 0; i < W; i++) {
        c[i]   *= 0.75;
        c[W+i] *= 0.88;
      }

      // ── Gentle global damping ─────────────────────────────────────────────
      for (let I = 0; I < N; I++) {
        u[I] *= 0.999; v[I] *= 0.999; c[I] *= 0.9985;
      }

      // ── Render (exponential tone map so smoke darkens as it accumulates) ───
      for (let I = 0; I < N; I++) {
        const tv = 1.0 - Math.exp(-c[I] * 2.0);
        const k = clamp((tv*(LUT-1)+0.5)|0, 0, LUT-1);
        pix[I*4] = lutR[k]; pix[I*4+1] = lutG[k]; pix[I*4+2] = lutB[k]; pix[I*4+3] = 255;
      }
      offCtx.putImageData(imgData, 0, 0);
      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = 'high';
      ctx.drawImage(off, 0, 0, canvas.width, canvas.height);
      _bgRafId = requestAnimationFrame(render);
    }

    render();
  }

  // ─── Bio card 3D tilt on hover ─────────────────────────────────────────────
  function initCardTilt() {
    const card = document.getElementById('bio-card') as HTMLElement | null;
    if (!card) return;

    card.addEventListener('mousemove', (e: MouseEvent) => {
      const rect = card.getBoundingClientRect();
      const x = ((e.clientX - rect.left) / rect.width  - 0.5) * 2;
      const y = ((e.clientY - rect.top)  / rect.height - 0.5) * 2;
      card.style.transform = `perspective(900px) rotateY(${x * 9}deg) rotateX(${-y * 7}deg) scale(1.02)`;
    });

    card.addEventListener('mouseleave', () => {
      card.style.transform = 'perspective(900px) rotateY(0deg) rotateX(0deg) scale(1)';
    });
  }

  document.addEventListener('astro:page-load', () => {
    cancelAnimationFrame(_bgRafId);
    if (_bgResize) { window.removeEventListener('resize', _bgResize); _bgResize = null; }
    initBg();
    initCardTilt();
  });

  document.addEventListener('astro:before-preparation', () => {
    cancelAnimationFrame(_bgRafId);
    if (_bgResize) { window.removeEventListener('resize', _bgResize); _bgResize = null; }
  });
</script>
